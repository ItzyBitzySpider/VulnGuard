rules:
  - id: node-postgres-sqli
    message: "lmao bro u got sqli"
    metadata:
      owasp:
        - A08:2021 - Software and Data Integrity Failures
      cwe:
        - "CWE-915: Improperly Controlled Modification of Dynamically-Determined
          Object Attributes"
      references:
        - https://node-postgres.com/features/queries
      category: security
      technology:
        - node-postgres
      subcategory:
        - vuln
      likelihood: MEDIUM
      impact: MEDIUM
      confidence: LOW
      license: Commons Clause License Condition v1.0[LGPL-2.1-only]
    languages:
      - javascript
      - typescript
    severity: WARNING
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-inside: |
              function ... (...,$FUNC,...) {
                ...
              }
          - focus-metavariable: $FUNC
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern-inside: |
                  const { $CLIENT } = require('pg')
                  ...
                  $DB = new $CLIENT(...)
                  ...
              - pattern-inside: |
                    ...
                    $PG = require('pg-promise')()
                    ...
                    $DB = $PG(...)
                    ...
              - pattern-inside: |
                  const { $POOL } = require('pg')
                  ...
                  const $NEWPOOL = new $POOL(...)
                  ...
                  $NEWPOOL.connect((..., $DB, ...) => {
                      ...
                  })
          - pattern-either: 
            - pattern: $DB.query($QUERY,...)
            - pattern: $DB.one($QUERY,...)
            - pattern: $DB.many($QUERY,...)
          - focus-metavariable: $QUERY
